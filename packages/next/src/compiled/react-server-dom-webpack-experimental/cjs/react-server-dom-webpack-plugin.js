/**
 * @license React
 * react-server-dom-webpack-plugin.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

'use strict';

'use strict';var t=require("path"),x=require("url"),z=require("neo-async"),A=require("acorn-loose"),B=require("webpack/lib/dependencies/ModuleDependency"),C=require("webpack/lib/dependencies/NullDependency"),D=require("webpack/lib/Template"),E=require("webpack");const F=Array.isArray;class G extends B{constructor(b){super(b)}get type(){return"client-reference"}}const H=require.resolve("../client.browser.js");
class I{constructor(b){this.ssrBundleConfigFilename=this.clientManifestFilename=this.chunkName=this.clientReferences=void 0;if(!b||"boolean"!==typeof b.isServer)throw Error("React Server Plugin: You must specify the isServer option as a boolean.");if(b.isServer)throw Error("TODO: Implement the server compiler.");b.clientReferences?"string"!==typeof b.clientReferences&&F(b.clientReferences)?this.clientReferences=b.clientReferences:this.clientReferences=[b.clientReferences]:this.clientReferences=[{directory:".",
recursive:!0,include:/\.(js|ts|jsx|tsx)$/}];"string"===typeof b.chunkName?(this.chunkName=b.chunkName,/\[(index|request)\]/.test(this.chunkName)||(this.chunkName+="[index]")):this.chunkName="client[index]";this.clientManifestFilename=b.clientManifestFilename||"react-client-manifest.json";this.ssrBundleConfigFilename=b.ssrBundleConfigFilename||"react-ssr-bundle-config.json"}apply(b){const p=this;let q,v=!1;const w=b.options.output.crossOriginLoading,u="string"===typeof w?"use-credentials"===w?w:"anonymous":
null;(new E.DefinePlugin({__WEBPACK_FLIGHT_CROSS_ORIGIN_CREDENTIALS__:"use-credentials"===u?"true":"false",__WEBPACK_FLIGHT_CROSS_ORIGIN_ANONYMOUS__:"anonymous"===u?"true":"false"})).apply(b);b.hooks.beforeCompile.tapAsync("React Server Plugin",(c,a)=>{c=c.contextModuleFactory;const e=b.resolverFactory.get("context",{}),d=b.resolverFactory.get("normal");p.resolveAllClientFiles(b.context,e,d,b.inputFileSystem,c,function(h,g){h?a(h):(q=g,a())})});b.hooks.thisCompilation.tap("React Server Plugin",(c,
a)=>{a=a.normalModuleFactory;c.dependencyFactories.set(G,a);c.dependencyTemplates.set(G,new C.Template);c=e=>{e.hooks.program.tap("React Server Plugin",()=>{const d=e.state.module;if(d.resource===H&&(v=!0,q))for(let g=0;g<q.length;g++){const l=q[g];var h=p.chunkName.replace(/\[index\]/g,""+g).replace(/\[request\]/g,D.toPath(l.userRequest));h=new E.AsyncDependenciesBlock({name:h},null,l.request);h.addDependency(l);d.addBlock(h)}})};a.hooks.parser.for("javascript/auto").tap("HarmonyModulesPlugin",c);
a.hooks.parser.for("javascript/esm").tap("HarmonyModulesPlugin",c);a.hooks.parser.for("javascript/dynamic").tap("HarmonyModulesPlugin",c)});b.hooks.make.tap("React Server Plugin",c=>{c.hooks.processAssets.tap({name:"React Server Plugin",stage:E.Compilation.PROCESS_ASSETS_STAGE_REPORT},function(){if(!1===v)c.warnings.push(new E.WebpackError("Client runtime at react-server-dom-webpack/client was not found. React Server Components module map file "+p.clientManifestFilename+" was not created."));else{var a=
new Set((q||[]).map(l=>l.request)),e={},d={chunkLoading:{prefix:c.outputOptions.publicPath||"",crossOrigin:u},ssrManifest:{}},h=d.ssrManifest;c.chunkGroups.forEach(function(l){function r(m,f){if(a.has(f.resource)&&(f=x.pathToFileURL(f.resource).href,void 0!==f)){const n={};e[f]={id:m,chunks:k,name:"*"};n["*"]={specifier:f,name:"*"};h[m]=n}}const k=[];l.chunks.forEach(function(m){m.files.forEach(f=>{f.endsWith(".js")&&k.push(f)})});l.chunks.forEach(function(m){m=c.chunkGraph.getChunkModulesIterable(m);
Array.from(m).forEach(function(f){const n=c.chunkGraph.getModuleId(f);r(n,f);f.modules&&f.modules.forEach(y=>{r(n,y)})})})});var g=JSON.stringify(e,null,2);c.emitAsset(p.clientManifestFilename,new E.sources.RawSource(g,!1));d=JSON.stringify(d,null,2);c.emitAsset(p.ssrBundleConfigFilename,new E.sources.RawSource(d,!1))}})})}resolveAllClientFiles(b,p,q,v,w,u){function c(a){if(-1===a.indexOf("use client"))return!1;let e;try{e=A.parse(a,{ecmaVersion:"2024",sourceType:"module"}).body}catch(d){return!1}for(a=
0;a<e.length;a++){const d=e[a];if("ExpressionStatement"!==d.type||!d.directive)break;if("use client"===d.directive)return!0}return!1}z.map(this.clientReferences,(a,e)=>{"string"===typeof a?e(null,[new G(a)]):p.resolve({},b,a.directory,{},(d,h)=>{if(d)return e(d);w.resolveDependencies(v,{resource:h,resourceQuery:"",recursive:void 0===a.recursive?!0:a.recursive,regExp:a.include,include:void 0,exclude:a.exclude},(g,l)=>{if(g)return e(g);g=l.map(r=>{var k=t.join(h,r.userRequest);k=new G(k);k.userRequest=
r.userRequest;return k});z.filter(g,(r,k)=>{q.resolve({},b,r.request,{},(m,f)=>{if(m||"string"!==typeof f)return k(null,!1);v.readFile(f,"utf-8",(n,y)=>{if(n||"string"!==typeof y)return k(null,!1);n=c(y);k(null,n)})})},e)})})},(a,e)=>{if(a)return u(a);a=[];for(let d=0;d<e.length;d++)a.push.apply(a,e[d]);u(null,a)})}}module.exports=I;
