import { join, relative, dirname } from 'path'

// This plugin modifies the require-ensure code generated by Webpack
// to work with Next.js SSR
export default class NextJsSsrImportPlugin {
  constructor ({ dir, dist }) {
    this.dir = dir
    this.dist = dist
  }

  apply (compiler) {
    compiler.plugin('compilation', (compilation) => {
      compilation.mainTemplate.plugin('require-ensure', (code, chunk) => {
        // Update to load chunks from our custom chunks directory
        const baseDirPath = join(this.dir, this.dist, 'dist')
        const pagePath = join(this.dir, this.dist, 'dist', dirname(chunk.name))
        const relativePathToBaseDir = relative(pagePath, baseDirPath)
        // Make sure even in windows, the path looks like in unix
        // Node.js require system will convert it accordingly
        const relativePathToBaseDirNormalized = relativePathToBaseDir.replace(/\\/g, '/')
        let updatedCode = code.replace('require("./"', `require("${relativePathToBaseDirNormalized}/"`)

        // Replace a promise equivalent which runs in the same loop
        // If we didn't do this webpack's module loading process block us from
        // doing SSR for chunks
        updatedCode = updatedCode.replace(
          'return Promise.resolve();',
          `return require('next/dynamic').SameLoopPromise.resolve();`
        )
        return updatedCode
      })
    })
  }
}
